# Sagapay frontend

Sagapay frontend is a payment gateway which supports multiple cryptocurrecny wallet and Stripe credit card payment.

## Install

### Requirements

- node.js 10.16.0 (Recommended)
- npm 6.9.0

### Steps

```
npm install
npm run start
```

If there is an error about `./build/Release/scrypt` not found, please enter the following command to fix:

```
cp node_modules/scrypt/build/Release/scrypt.node node_modules/scrypt/build/Release/scrypt
```

Once the dev server launched correctly, please navigate to [here](http://localhost:3000?data=ewogICJ1dWlkIjogIjEyMzQiLAogICJjcnlwdG9jdXJyZW5jeSI6IHsKICAgICJuYW1lIjogIkVSQzc3NyIsCiAgICAidG9rZW4iOiAiMHhhRkY0NDgxRDEwMjcwRjUwZjIwM0UwNzYzZTI1OTc3NzYwNjhDQmM1IiwKICAgICJyZWN2IjogIjB4NTM1OUU3NTQ0ZDQ4ZGI3ODE3MkYxMEZmQTMyMmExZDFiMjVFOTI1OSIsCiAgICAiZGVjaW1hbCI6ICIxOCIsCiAgICAiYW1vdW50IjogIjEwMDAwMDAwMDAwMDAwMDAwMDAiLAogICAgImFwaSI6ICJodHRwOi8vZXhhbXBsZS5jb20iCiAgfSwKICAiY3JlZGl0Y2FyZCI6IHsKICAgICJrZXkiOiAicGtfdGVzdF9YMkNLSXdaaENFeDk5dVk4Vmc4d2d0RlQiLAogICAgImFtb3VudCI6ICIxIiwKICAgICJjdXJyZW5jeSI6ICJOVEQiLAogICAgImFwaSI6ICJodHRwOi8vbG9jYWxob3N0IgogIH0KfQ==) and you should see 3 button (Cryptocurrency Pay, Credit Card pay, and Mobile Brower) on the interface.

### Build

`npm run build`

Builds the app for production to the `build` folder.<br>
It correctly bundles React in production mode and optimizes the build for the best performance.

The build is minified and the filenames include the hashes.<br>
Your app is ready to be deployed!

### `npm run build` fails to minify

This section has moved here: https://facebook.github.io/create-react-app/docs/troubleshooting#npm-run-build-fails-to-minify

## Input parameter

The Sagapay frontend handles both cryptocurrency payment and credit card payment for you. A correct JSON input should be provide via the get parameter, see example as follow:

### Input example (JSON)

```json
{
  "uuid": "1234",
  "cryptocurrency": {
    "name": "ERC777",
    "token": "0xaFF4481D10270F50f203E0763e2597776068CBc5",
    "recv": "0x5359E7544d48db78172F10FfA322a1d1b25E9259",
    "decimal": "18",
    "amount": "1000000000000000000",
    "api": "http://example.com"
  },
  "creditcard": {
    "key": "pk_test_X2CKIwZhCEx99uY8Vg8wgtFT",
    "amount": "1",
    "currency": "NTD",
    "api": "http://localhost"
  }
}
```

- uuid: The UUID of this transaction, should be generated by backend server
- cryptocurrency.token: The contract address of the token to transfer
- cryptocurrency.recv: The receiver of the token
- cryptocurrency.decimal: The token decimal defined in the contract of the token
- cryptocurrency.amount: The amount of token to transfer
- cryptocurrency.api: The API endpoint to call after the transaction completes
- creditcard.key: The Stripe public key (test or production)
- creditcard.amount: The amount to charge (only to display for the client)
- creditcard.currency: The currency to charge (only to display for the client)
- creditcard.api: The API endpoint to call after the transaction completes

### Parameter encoding

Parameter should be in valid JSON format and encoded with base64 encoding. Passed to the sagapay frontend in `?data` parameter as the example mention in the install section.

## Output

The output will be HTTP `POST` to the API URL specificed in the input JSON with the following format:

### Output Example (crpyto)

```json
{
  "uuid": "1234",
  "userSelect": "cryptocurrency",
  "cryptocurrency": {
    "txid": "0x00..."
  }
}
```

Note: we did not pass `amount` here for security reason, the backend server should obtain such information via looking up the uuid of this transaction.

### Dev note for crypto payment on backend

The backend server should be able to connect to **Ethereum mainnet** to verify the transaction using the TXID and UUID provided.

Recommended steps to be taken:

1. Lookup the UUID and obtain this transaction's `token address`, `receiver address`, `decimal`, `amount`
2. Connect to ETH mainnet and lookup the transaction with the provided TXID
3. Check if the 4 column mentioned above matches with the queryed information on the blockchain
4. Check if the TX has been processed and confirmed by the ETH network

### Output Example (creditcard)

```json
{
  "uuid": "1234",
  "userSelect": "creditcard",
  "creditcard": {
    "token": "tok_xxx"
  }
}
```

Note: we did not pass `amount` and `currency` here for security reason, the backend server should obtain such information via looking up the uuid of this transaction.

### Dev note for crypto payment on backend

The token in the output is a credit card token obtain by stripe.js. **No charge has been made at this time since we can't accomplish this in the frontend**.

In order to actually charge the client's card. You must complete the following steps in the backend server:

1. Lookup the UUID and obtain clients `email`, `amount` and `currency`
2. Have the corresponding stripe private key ready
3. Create a customer object via stripe `Customer` API and apply credit card token to the object
4. Use stripe `InvoiceItem` API to create a pending invoice
5. Use stripe `Invoice` API to create a invoice and collect the payment
